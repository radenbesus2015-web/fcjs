(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,644075,e=>{"use strict";var t=e.i(846696);let a={success:"success",error:"error",warn:"warning",info:"info"},r={type:"info",title:"",message:"",delay:0,duration:3200,dismissible:!0,actionText:"",onAction:()=>{}};function s(e={}){let i={...r,..."string"==typeof e?{message:e}:e},n=a[i.type]||"info",c=()=>{var e;let a;return String((t.toast[n]||t.toast)(i.title||(e=i.type,(a="en"===function(){try{let e=localStorage.getItem("settings");if(!e)return"en";let t=JSON.parse(e),a=String(t?.language||"").toLowerCase();return"id"===a?"id":"en"}catch{return"en"}}()?{success:"Success",error:"Error",warn:"Warning",info:"Info"}:{success:"Berhasil",error:"Gagal",warn:"Perhatian",info:"Info"})[e]||a.info),{description:i.message||"",duration:i.duration,...i.actionText&&i.onAction?{action:{label:i.actionText,onClick:()=>i.onAction?.()}}:{},onDismiss:()=>{},onAutoClose:()=>{}}))};if(i.delay>0){let e=setTimeout(c,i.delay);return{id:null,cancel:()=>clearTimeout(e)}}return c()}e.s(["toast",0,{show:s,success:(e,t={})=>s({type:"success",message:e,...t||{}}),error:(e,t={})=>s({type:"error",message:e,...t||{}}),warn:(e,t={})=>s({type:"warn",message:e,...t||{}}),info:(e,t={})=>s({type:"info",message:e,...t||{}}),dismiss:e=>t.toast.dismiss(e)}])},6080,e=>{"use strict";var t=e.i(843476),a=e.i(271645),r=e.i(469701),s=e.i(567150),i=e.i(840463),n=e.i(644075),c=e.i(554858),l=e.i(167881),o=e.i(70051),d=e.i(394315);function u(){let{t:e}=(0,r.useI18n)(),u=(0,d.useConfirmDialog)(),{useSetting:m}=(0,s.useSettings)(),g=(0,a.useRef)(null),h=(0,a.useRef)(null),f=(0,a.useRef)(null),p=(0,a.useRef)(null),b=(0,a.useRef)(null),[x,w]=(0,a.useState)(!1),[y,j]=(0,a.useState)(""),[k,v]=(0,a.useState)(""),[F,N]=(0,a.useState)(!1),[S,R]=(0,a.useState)(!1),[C,T]=(0,a.useState)(0),[I,A]=(0,a.useState)(null),[E,U]=(0,a.useState)(""),[B,W]=(0,a.useState)(!1),[D]=(0,a.useState)(!1),[L,O]=(0,a.useState)(""),[P,G]=(0,a.useState)([]),{model:M}=m("baseInterval",{clamp:{max:5e3,round:!0}}),{model:K}=m("attendance.sendWidth",{clamp:{min:160,max:1920,round:!0}}),{model:J}=m("attendance.jpegQuality",{clamp:{min:0,max:1}});(0,i.useWs)({url:"",root:!0,on:{connect(){j(e("registerFace.status.wsConnected","WS terhubung")),n.toast.success(e("registerFace.toast.wsConnected","Terhubung ke server WebSocket"))},disconnect(){j(e("registerFace.status.wsDisconnected","WS terputus")),n.toast.warn(e("registerFace.toast.wsDisconnected","Koneksi WebSocket terputus"))},face_detection(t){let a=Array.isArray(t?.faces)?t.faces:[];R(a.length>0),T(a.length),j(a.length>0?e("registerFace.status.faces","Jumlah wajah: {count}",{count:a.length}):e("registerFace.status.noFace","Tidak ada wajah terdeteksi"))}}});let _=async()=>{if(g.current)try{let t=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480},facingMode:"user"},audio:!1});g.current.srcObject=t,w(!0),j(e("registerFace.status.cameraActive","Kamera aktif")),await new Promise(e=>{(g.current?.readyState||0)>=2?e(void 0):g.current&&(g.current.onloadedmetadata=()=>e(void 0))})}catch(t){j(e("registerFace.status.cameraDenied","Akses kamera ditolak")),n.toast.error(e("registerFace.toast.cameraError","Gagal mengakses kamera"))}},q=()=>{g.current?.srcObject&&(g.current.srcObject.getTracks().forEach(e=>e.stop()),g.current.srcObject=null),w(!1),j(e("registerFace.status.cameraStopped","Kamera dihentikan"))},H=(e,t)=>{if(!e||!t)return;let a=t.getBoundingClientRect(),r=window.devicePixelRatio||1;e.width=Math.max(1,Math.round(a.width*r)),e.height=Math.max(1,Math.round(a.height*r)),e.style.width=`${a.width}px`,e.style.height=`${a.height}px`;let s=e.getContext("2d");s&&s.setTransform(r,0,0,r,0,0)},$=e=>{let t=e?.getContext("2d");t&&e&&t.clearRect(0,0,e.width,e.height)},z=async()=>{try{if(!g.current)return;let t=f.current;if(!t)return;let a=t.getContext("2d");if(!a)return;t.width=g.current.videoWidth||640,t.height=g.current.videoHeight||480,a.drawImage(g.current,0,0);try{g.current.pause()}catch{}W(!0),await new Promise(e=>setTimeout(()=>e(),0));let r=await new Promise(e=>t.toBlob(t=>e(t),"image/jpeg",.92));if(!r){W(!1);try{await g.current.play()}catch{}return}try{let t=new FormData;t.append("file",r,"capture.jpg"),j(e("registerFace.status.processing","Memproses..."));let a=await (0,c.postForm)("/register-face/preview",t),s=Array.isArray(a?.faces)?a.faces:[],i=Array.isArray(a?.faces_cropped)?a.faces_cropped:[],n=a?.preview_is_cropped?i:s,l=Number(a?.detected??n.length??0);T(l),G(n),O(String(a?.token||""));let o=String(a?.preview||"")||URL.createObjectURL(r);try{E&&E.startsWith("blob:")&&URL.revokeObjectURL(E)}catch{}U(o),j(l>0?e("registerFace.status.faces","Jumlah wajah: {count}",{count:l}):e("registerFace.status.noImage","Tidak ada gambar.")),requestAnimationFrame(()=>{let e=document.getElementById("preview-img");e&&h.current&&((e,t,a)=>{H(t,e);let r=t.getContext("2d");if(r)for(let e of($(t),r.lineWidth=3,r.strokeStyle="#38bdf8",a)){let[t,a,s,i]=e.bbox||[0,0,0,0];r.strokeRect(t,a,s,i)}})(e,h.current,n)})}catch(e){O(""),G([]),T(0)}q(),requestAnimationFrame(()=>p.current?.focus())}catch{W(!1);try{await g.current?.play()}catch{}}finally{W(!1)}},Q=async()=>{if(E)try{let e=await fetch(E).then(e=>e.blob());return await new Promise((t,a)=>{let r=new FileReader;r.onload=()=>t(String(r.result||"")),r.onerror=()=>a(Error("read error")),r.readAsDataURL(e)})||null}catch{}if(I)return await new Promise((e,t)=>{let a=new FileReader;a.onload=()=>e(String(a.result||"")),a.onerror=()=>t(Error("read error")),a.readAsDataURL(I)})||null;if(!g.current)return null;let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return null;e.width=g.current.videoWidth||640,e.height=g.current.videoHeight||480,t.drawImage(g.current,0,0);let a=Number(J?.model??.8);return e.toDataURL("image/jpeg",a||.8)},V=async()=>{if(!k.trim())return void n.toast.error(e("registerFace.toast.nameRequired","Nama harus diisi"));let t=await Q();if(!t)return void n.toast.error(e("registerFace.toast.noImage","Tidak ada gambar dari kamera atau upload"));let a=async e=>{let a=await (async()=>{if(t.startsWith("data:")){let e=await fetch(t);return await e.blob()}return new Blob([t],{type:"image/jpeg"})})(),r=new FormData;return r.append("label",k.trim()),r.append("file",a,"face.jpg"),r.append("force",e?"1":"0"),await (0,c.postForm)("http://localhost:8000/register-face",r)};N(!0);try{console.log("[REGISTER] Starting registration for:",k.trim());let t=await a(!1);console.log("[REGISTER] Response:",t);let r=t&&("ok"===t.status||t.success||t.ok),s=!r&&(t?.duplicate||/duplicate|exists|sudah terdaftar|already/i.test(String(t?.message||t?.error||"")));if(!r&&s){if(!await u({title:e("registerFace.confirm.replaceTitle","Ganti foto?"),description:e("registerFace.toast.labelMustMatch","Wajah terdaftar sebagai {label}. Gunakan label tersebut untuk memperbarui.",{label:k.trim()}),confirmText:e("registerFace.confirm.replaceAction","Ganti"),cancelText:e("common.cancel","Batal")}))throw Error(t?.message||t?.error||"Duplicate, cancelled by user");t=await a(!0)}if(t&&("ok"===t.status||t.success||t.ok)){let a=t.label||k.trim();n.toast.success(e("registerFace.toast.registerSuccess","Terdaftar: {label}",{label:a})),v(""),A(null),U(""),W(!1)}else{let e=t?.error||t?.message||"Registration failed";throw Error(e)}}catch(a){console.error("[REGISTER] Error:",a);let t="Unknown error";a instanceof Error?t=a.message:a?.data?t=a.data?.message||a.data?.detail||JSON.stringify(a.data):"string"==typeof a?t=a:"object"==typeof a&&(t=JSON.stringify(a)),n.toast.error(e("registerFace.toast.registerError","Registrasi gagal: {error}",{error:t}))}finally{N(!1)}};return(0,a.useEffect)(()=>(_(),()=>{q()}),[]),(0,t.jsx)("div",{className:"space-y-6",children:(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 items-start",children:[(0,t.jsxs)("div",{className:"bg-card rounded-lg border p-6",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-widest text-muted-foreground",children:e("registerFace.sections.camera.title","Kamera & Pratinjau")}),(0,t.jsx)("h3",{className:"text-lg font-semibold mb-3",children:e("registerFace.sections.camera.subtitle","Tangkap wajah")}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground mb-4",children:e("registerFace.header.subtitle","Ambil foto dari kamera atau unggah gambar untuk menambahkan identitas baru ke database.")}),(0,t.jsxs)("div",{className:"relative overflow-hidden rounded-2xl border bg-muted/30",children:[E?(0,t.jsx)("img",{src:E,onLoad:()=>H(h.current,document.querySelector("#preview-img")||null),id:"preview-img",alt:"preview",className:"w-full"}):(0,t.jsx)("video",{ref:g,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full"}),E&&(0,t.jsx)("canvas",{ref:h,className:"absolute inset-0 h-full w-full"}),(0,t.jsxs)("div",{className:"pointer-events-auto absolute bottom-4 right-4 flex flex-wrap items-center gap-2",children:[x&&(0,t.jsxs)(l.Button,{type:"button",onClick:z,disabled:F,children:[(0,t.jsx)(o.Icon,{name:"Camera",className:"mr-2 h-4 w-4"}),e("registerFace.actions.capture","Tangkap")]}),(0,t.jsxs)(l.Button,{type:"button",variant:"outline",onClick:()=>{try{E&&E.startsWith("blob:")&&URL.revokeObjectURL(E)}catch{}if(U(""),O(""),G([]),$(h.current),j(e("registerFace.status.noImage","Tidak ada gambar.")),x)try{g.current?.play()}catch{}else _()},disabled:x,className:"backdrop-blur-md",children:[(0,t.jsx)(o.Icon,{name:"RotateCcw",className:"mr-2 h-4 w-4"}),e("registerFace.actions.reset","Reset")]})]}),D&&(0,t.jsx)("div",{className:"pointer-events-none absolute inset-0 z-20 grid place-items-center bg-background/75 text-sm text-muted-foreground",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Icon,{name:"Loader2",className:"h-4 w-4 animate-spin"}),e("registerFace.status.processingCrop","Memproses foto...")]})})]}),(0,t.jsxs)("div",{className:"mt-4 flex items-center gap-2",children:[(0,t.jsxs)(l.Button,{onClick:x?q:_,children:[(0,t.jsx)(o.Icon,{name:x?"CameraOff":"Camera",className:"h-4 w-4 mr-2"}),x?e("registerFace.actions.stopCamera","Hentikan Kamera"):e("registerFace.actions.openCamera","Gunakan Kamera")]}),(0,t.jsxs)("div",{className:"ml-auto flex items-center gap-3",children:[(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:y}),(0,t.jsxs)("span",{className:"inline-flex items-center gap-1 rounded-full border bg-background/80 backdrop-blur px-2.5 py-0.5 text-xs font-medium",children:[(0,t.jsx)(o.Icon,{name:"UserScan",className:"h-3 w-3"}),e("registerFace.status.faceBadge","{count} wajah",{count:C})]})]})]}),(0,t.jsx)("canvas",{ref:f,className:"hidden"})]}),(0,t.jsxs)("div",{className:"bg-card rounded-lg border p-6",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-widest text-muted-foreground",children:e("registerFace.sections.details.title","Detail Wajah")}),(0,t.jsx)("h3",{className:"text-lg font-semibold mb-4 border-b",children:e("registerFace.sections.details.subtitle","Informasi Identitas")}),(0,t.jsx)("span",{className:"border-b"}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:e("registerFace.fields.label","Label / Nama")}),(0,t.jsx)("input",{type:"text",ref:p,value:k,onChange:e=>v(e.target.value),className:"w-full px-3 py-2 border rounded-md",placeholder:e("registerFace.fields.labelPlaceholder","Nama lengkap")})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-sm font-medium mb-2",children:e("registerFace.fields.upload","Unggah Gambar")}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)(l.Button,{type:"button",variant:"outline",onClick:()=>b.current?.click(),children:e("registerFace.fields.chooseFile","Pilih berkas")}),(0,t.jsx)("span",{className:"text-sm text-muted-foreground truncate",children:I?.name||e("registerFace.fields.noFile","Tidak ada berkas yang dipilih")})]}),(0,t.jsx)("input",{ref:b,type:"file",accept:"image/*",onChange:e=>A(e.target.files?.[0]||null),className:"sr-only","aria-label":e("registerFace.fields.upload","Unggah Gambar")})]}),(0,t.jsxs)("div",{className:"pt-2",children:[(0,t.jsxs)(l.Button,{onClick:V,disabled:F,children:[(0,t.jsx)(o.Icon,{name:"Send",className:"h-4 w-4 mr-2"}),e("registerFace.actions.submit","Daftarkan")]}),(0,t.jsx)(l.Button,{onClick:()=>{v(""),A(null),N(!1),R(!1),T(0)},variant:"outline",className:"ml-2",disabled:F,children:e("registerFace.actions.reset","Reset")})]})]})]})]})})}e.s(["default",()=>u])}]);